#!/bin/bash

: ${DOPS_BIN_DIR:="$(dirname "$(readlink -f "$0")")"}
: ${DOPS_DIR:="$(cd "$DOPS_BIN_DIR/.."; pwd)"}

. "$DOPS_DIR/dopsh_functions.sh"

dopsh-init "$0" "$@"
dopsh-parseopt "H:help -b= --branch=branch -k= --key=sshkey -s= --stamp=stampfile -u= --user= url [dir]" "$@" || exit 1

dopsh-opt       branch HEAD b
dopsh-opt -file key    ""   k
dopsh-opt -file stamp  ""   s
dopsh-opt       user   ""   u
dopsh-opt -file dir    "$(basename "$op_url")"

wrapgitop=()

if [ -n "$user" ]; then
  wrapgitop=("${wrapgitop[@]}" sudo -u "$op_user")
fi

if [ -n "$op_key" ]; then
  if ! [ -e "$op_key" ]; then
    echo "$op_key: not found" >&2
    exit 10
  fi

  if ! which git-ssh-wrapper >/dev/null 2>&1; then
    do-install-file /usr/bin/gem
    gem install git-ssh-wrapper
  fi
  
  wrapgitop=("${wrapgitop[@]}" git-ssh-wrapper "$op_key")
fi

wrapgit(){
  "${wrapgitop[@]}" git "$@"
}

[ 1 = "$REDO_XTRACE" ] && set -x
set -e

if [ -e "$op_dir/.git" ]; then
  cd "$op_dir"
  wrapgit fetch "$op_url" "$op_branch"
  wrapgit reset --hard FETCH_HEAD
  wrapgit submodule update --init --recursive --force
elif [ -e "$op_dir" ]; then
  echo "$op_dir: already exists" >&2
  exit 11
else
  if [ HEAD != "$op_branch" ]; then
    wrapgit clone --recursive -b "$op_branch" "$op_url" "$op_dir"
  else
    wrapgit clone --recursive "$op_url" "$op_dir"
  fi
  cd "$op_dir"
fi

if [ -n "$op_stamp" ]; then
  git rev-parse HEAD >"$op_stamp"
fi

