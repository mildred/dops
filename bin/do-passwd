#!/bin/sh

zero="$(basename "$0")"
usage(){
  cat <<EOF
$zero declare-user [--shell SHELL] [--home HOMEDIR] USER
EOF
}

warn(){
  printf "$@" >&2
}

has(){
  which "$@" >/dev/null 2>&1
}

operation=help
user=
shell=
home=
login_group=

while [ $# -gt 0 ]; do
  case "$1" in
    -h|--help|help)
      usage >&2
      exit 1
      ;;
    declare-user)
      operation=declare-user
      shift
      ;;
    --shell)
      shell="$2"
      shift 2
      ;;
    --home)
      home="$2"
      shift 2
      ;;
    --)
      shift
      break
      ;;
    *)
      case $operation in
        declare-user)
          user="$1"
          ;;
        *)
          warn "Unknown parameter %s\n" "$1"
          ;;
      esac
      shift
      ;;
  esac
done

has_user(){
  cut -d: -f1 /etc/passwd | fgrep -x "$1" >/dev/null
}

has_group(){
  cut -d: -f1 /etc/group | fgrep -x "$1" >/dev/null
}

declare_group(){
  local group="$1"
  if ! has_group "$group"; then
    if has groupadd; then
      ( set -x; groupadd "$group" )
      return $?
    else
      warn "Cannot create group $group: Unknown platform"
      return 1
    fi
  fi
}

case $operation in
  declare-user)
    if [ -z "$user" ]; then
      warn "Missing username"
      exit 1
    fi
    : ${login_group:="$user"}
    if ! has_user "$user"; then
      if has useradd; then
        op="--create-home -g '$login_group'"
        [ -n "$home"  ] && op+=" --home '$home'"
        [ -n "$shell" ] && op+=" --shell '$shell'"
        set -e
        declare_group "$login_group"
        ( set -x; useradd $op "$user" )
      else
        warn "Cannot create user: Unknown platform"
        exit 1
      fi
    else
      if has usermod; then
        op="--move-home -g '$login_group'"
        [ -n "$home"  ] && op+=" --home '$home'"
        [ -n "$shell" ] && op+=" --shell '$shell'"
        set -e
        declare_group "$login_group"
        ( set -x; usermod $op "$user" )
      else
        warn "Cannot update user: Unknown platform"
        exit 1
      fi
    fi
    if [ -n "$home" ] && ! [ -e "$home" ]; then
      ( set -x; install -o "$user" -g "$login_group" -m 0711 -d "$home" )
    fi
    ;;
  *)
    usage >&2
    exit 1
    ;;
esac

